{% extends "base.html" %}

{% block content %}
<div id="app-container" class="animate-fade-in" style="animation: fadeIn 0.4s ease-out forwards;">

    <div class="row justify-content-center mb-5">
        <div class="col-md-10 col-lg-8 text-center">
            <h2 class="fw-bold mb-4 text-dark gradient-text">Find Your Parts</h2>
            <p class="text-muted mb-4">Search by Product ID (PCS/TRIAD) or Part Number</p>

            <div class="search-box position-relative shadow-sm rounded-pill bg-white p-2 d-flex align-items-center"
                style="border: 1px solid #e2e8f0; transition: all 0.3s ease;">
                <i class="fas fa-search ms-3 text-muted"></i>
                <input type="text" id="search-input" class="form-control border-0 bg-transparent fs-5 ms-2 shadow-none"
                    placeholder="e.g. TDI1000106 or 56003342" autocomplete="off" style="outline: none;">
                <button id="search-btn"
                    class="btn btn-primary rounded-pill px-4 ms-2 fw-semibold fade-hoover">Search</button>
            </div>
            <div id="search-error" class="text-danger mt-2 small text-start d-none"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center d-none mb-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Results Table -->
    <div id="results-container" class="card shadow-sm border-0 rounded-4 d-none overflow-hidden">
        <div class="card-header bg-white border-bottom-0 pt-4 pb-0 px-4">
            <h5 id="results-title" class="fw-bold m-0 text-dark">Search Results</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0"
                    style="border-collapse: separate; border-spacing: 0;">
                    <thead class="bg-light text-muted small text-uppercase" style="border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th class="ps-4 py-3">Product ID (PCS)</th>
                            <th class="py-3">Product ID (TRIAD)</th>
                            <th class="py-3">Distributor Part Num</th>
                            <th class="py-3">Alternate Part Num</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- Data populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- No Results State -->
    <div id="no-results" class="text-center p-5 d-none bg-white rounded-4 shadow-sm">
        <div class="display-1 text-muted opacity-25 mb-3">
            <i class="fas fa-box-open"></i>
        </div>
        <h4 class="text-muted">No results found</h4>
        <p class="text-muted small">Try adjusting your search criteria.</p>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchErrorDisplay = document.getElementById('search-error');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const resultsBody = document.getElementById('results-body');
        const noResultsDiv = document.getElementById('no-results');

        function showError(message) {
            searchErrorDisplay.textContent = message;
            searchErrorDisplay.classList.remove('d-none');
        }

        function clearError() {
            searchErrorDisplay.classList.add('d-none');
        }

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const searchTerm = searchInput.value.trim();
            clearError();

            if (!searchTerm) {
                showError('Please enter a search term.');
                return;
            }

            // Reset UI
            resultsContainer.classList.add('d-none');
            noResultsDiv.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            resultsBody.innerHTML = '';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(searchTerm)}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const results = await response.json();

                loadingSpinner.classList.add('d-none');

                if (results.length === 0) {
                    noResultsDiv.classList.remove('d-none');
                } else {
                    renderResults(results);
                    resultsContainer.classList.remove('d-none');
                }

            } catch (error) {
                console.error("Error searching:", error);
                loadingSpinner.classList.add('d-none');
                showError(`Search failed: ${error.message}`);
            }
        }

        function renderResults(results) {
            resultsBody.innerHTML = '';
            results.forEach(part => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="ps-4 py-3 fw-medium text-dark" style="border-bottom: 1px solid #f1f5f9;">${part.product_id_pcs || '-'}</td>
          <td class="py-3" style="border-bottom: 1px solid #f1f5f9;">${part.product_id_triad || '-'}</td>
          <td class="py-3" style="border-bottom: 1px solid #f1f5f9;">${part.distributor_part_number || '-'}</td>
          <td class="py-3" style="border-bottom: 1px solid #f1f5f9;">${part.alternate_part_number || '-'}</td>
        `;
                resultsBody.appendChild(tr);
            });
        }
    });
</script>
{% endblock %}